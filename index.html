<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>餐費小本本</title>
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <h1>餐費小本本</h1>
          <div class="sub">
            輸入金額後新增；自動加總並顯示距離滿額 5700 的差額
          </div>
        </div>
        <div class="col small">
          <label>月份</label>
          <select id="monthSelect" style="min-width: 160px"></select>
        </div>
        <div class="col small" style="min-width: 160px">
          <label>主題</label>
          <div class="themeToggle">
            <input id="themeToggle" type="checkbox" />
            <span id="themeText">深色</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="col small">
            <label>日期</label>
            <input id="dateInput" type="date" />
          </div>
          <div class="col">
            <label>金額（必填）</label>
            <input
              id="amountInput"
              inputmode="numeric"
              placeholder="例如：230"
            />
          </div>
          <div class="col">
            <label>備註（選填）</label>
            <input id="noteInput" placeholder="例如：午餐 / 聚餐" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="addBtn">新增</button>
          <button id="exportBtn">匯出 CSV</button>
          <button class="danger" id="clearBtn">清空本月</button>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="k">本月筆數</div>
            <div class="v" id="countText">0</div>
          </div>
          <div class="stat">
            <div class="k">本月總額</div>
            <div class="v" id="totalText">$0</div>
          </div>
          <div class="stat">
            <div class="k">距離滿 5700 還差</div>
            <div class="v" id="remainText">$5,700</div>
          </div>
        </div>

        <div class="progressWrap">
          <div class="bar">
            <div class="fill" id="progressFill"></div>
          </div>
          <div class="hint" id="progressHint">進度：0%</div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width: 180px">日期</th>
              <th style="width: 140px">備註</th>
              <th class="right" style="width: 140px">金額</th>
              <th class="right" style="width: 110px">操作</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td colspan="4" class="muted">目前沒有紀錄</td>
            </tr>
          </tbody>
        </table>

        <div class="footerNote">
          資料儲存在這台裝置的瀏覽器（localStorage）。換瀏覽器/換裝置不會自動同步。
        </div>
      </div>
    </div>

    <script>
      const TARGET = 5700;

      const els = {
        monthSelect: document.getElementById("monthSelect"),
        dateInput: document.getElementById("dateInput"),
        amountInput: document.getElementById("amountInput"),
        noteInput: document.getElementById("noteInput"),
        addBtn: document.getElementById("addBtn"),
        clearBtn: document.getElementById("clearBtn"),
        exportBtn: document.getElementById("exportBtn"),
        tbody: document.getElementById("tbody"),
        countText: document.getElementById("countText"),
        totalText: document.getElementById("totalText"),
        remainText: document.getElementById("remainText"),
        progressFill: document.getElementById("progressFill"),
        progressHint: document.getElementById("progressHint"),
        themeToggle: document.getElementById("themeToggle"),
        themeText: document.getElementById("themeText"),
      };

      const fmtMoney = (n) => {
        const v = Math.round(Number(n) || 0);
        return "$" + v.toLocaleString("zh-TW");
      };

      const pad2 = (n) => String(n).padStart(2, "0");
      const today = new Date();
      const thisMonthKey = () =>
        `${today.getFullYear()}-${pad2(today.getMonth() + 1)}`;

      function makeMonthOptions() {
        // 最近 6 個月：本月往回 5 個月
        const base = new Date(today.getFullYear(), today.getMonth(), 1);
        const months = [];

        for (let i = 5; i >= 0; i--) {
          const d = new Date(base.getFullYear(), base.getMonth() - i, 1);
          months.push(`${d.getFullYear()}-${pad2(d.getMonth() + 1)}`);
        }

        // 再把 localStorage 裡已存在的月份補上
        const keys = Object.keys(localStorage).filter((k) =>
          k.startsWith("mealRecords:")
        );
        for (const k of keys) {
          const mk = k.split(":")[1];
          if (mk && !months.includes(mk)) months.push(mk);
        }

        // 由舊到新排序
        months.sort();

        // 產生選單
        els.monthSelect.innerHTML = months
          .map((m) => `<option value="${m}">${m}</option>`)
          .join("");

        // 預設選本月
        els.monthSelect.value = thisMonthKey();
      }

      const storageKey = (monthKey) => `mealRecords:${monthKey}`;

      function loadRecords(monthKey) {
        try {
          const raw = localStorage.getItem(storageKey(monthKey));
          const data = raw ? JSON.parse(raw) : [];
          return Array.isArray(data) ? data : [];
        } catch {
          return [];
        }
      }

      function saveRecords(monthKey, records) {
        localStorage.setItem(storageKey(monthKey), JSON.stringify(records));
      }

      function normalizeAmount(input) {
        // 只留數字
        const s = String(input ?? "").replace(/[^\d]/g, "");
        if (!s) return null;
        const n = Number(s);
        if (!Number.isFinite(n) || n <= 0) return null;
        return Math.round(n);
      }

      function render() {
        const monthKey = els.monthSelect.value;
        const records = loadRecords(monthKey);

        // sort: 日期 desc, 同日則新增順序 desc
        records.sort((a, b) => {
          const da = a.date || "";
          const db = b.date || "";
          if (da === db) return (b.createdAt || 0) - (a.createdAt || 0);
          return db.localeCompare(da);
        });

        const total = records.reduce(
          (sum, r) => sum + (Number(r.amount) || 0),
          0
        );
        const remain = Math.max(0, TARGET - total);
        const pct = Math.min(100, Math.round((total / TARGET) * 100));

        els.countText.textContent = String(records.length);
        els.totalText.textContent = fmtMoney(total);

        if (remain === 0) {
          els.remainText.textContent = "$0";
          els.remainText.classList.add("okText");
          els.remainText.classList.remove("dangerText");
        } else {
          els.remainText.textContent = fmtMoney(remain);
          els.remainText.classList.add("dangerText");
          els.remainText.classList.remove("okText");
        }

        els.progressFill.style.width = pct + "%";
        els.progressFill.classList.toggle("full", pct >= 100);
        els.progressHint.textContent = `進度：${pct}%（目標 ${fmtMoney(
          TARGET
        )}）`;

        // table
        if (records.length === 0) {
          els.tbody.innerHTML = `<tr><td colspan="4" class="muted">目前沒有紀錄</td></tr>`;
          return;
        }

        els.tbody.innerHTML = records
          .map((r) => {
            const d = r.date || "";
            const note = (r.note || "")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;");
            return `
          <tr>
            <td>${d || '<span class="muted">（未填）</span>'}</td>
            <td>${note || '<span class="muted">—</span>'}</td>
            <td class="right amt">${fmtMoney(r.amount)}</td>
            <td class="right">
              <button class="miniBtn" data-action="del" data-id="${
                r.id
              }">刪除</button>
            </td>
          </tr>
        `;
          })
          .join("");
      }

      function addRecord() {
        const monthKey = els.monthSelect.value;

        const amount = normalizeAmount(els.amountInput.value);
        if (amount == null) {
          alert("金額請輸入正整數");
          els.amountInput.focus();
          return;
        }

        const date = els.dateInput.value || "";
        const note = (els.noteInput.value || "").trim();

        const records = loadRecords(monthKey);
        records.push({
          id: crypto.randomUUID
            ? crypto.randomUUID()
            : String(Date.now()) + Math.random().toString(16).slice(2),
          date,
          note,
          amount,
          createdAt: Date.now(),
        });
        saveRecords(monthKey, records);

        // reset inputs (日期保留，方便連續輸入同一天)
        els.amountInput.value = "";
        els.noteInput.value = "";
        els.amountInput.focus();

        render();
      }

      function clearMonth() {
        const monthKey = els.monthSelect.value;
        const records = loadRecords(monthKey);
        if (records.length === 0) return;

        const ok = confirm(`確定要清空 ${monthKey} 的所有紀錄？`);
        if (!ok) return;

        localStorage.removeItem(storageKey(monthKey));
        render();
      }

      function exportCSV() {
        const monthKey = els.monthSelect.value;
        const records = loadRecords(monthKey);

        const header = ["date", "note", "amount"];
        const rows = records.map((r) => [
          r.date || "",
          (r.note || "").replaceAll('"', '""'),
          String(r.amount || 0),
        ]);

        const csv = [
          header.join(","),
          ...rows.map((cols) => `${cols[0]},"${cols[1]}",${cols[2]}`),
        ].join("\n");

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `餐費記錄_${monthKey}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
      }

      // ========================
      // Theme (dark/light)
      // ========================
      const THEME_KEY = "mealTheme";

      function applyTheme(theme) {
        // theme: 'dark' | 'light'
        if (theme === "light") {
          document.documentElement.setAttribute("data-theme", "light");
          els.themeToggle.checked = true;
          els.themeText.textContent = "淺色";
        } else {
          document.documentElement.removeAttribute("data-theme");
          els.themeToggle.checked = false;
          els.themeText.textContent = "深色";
        }
        localStorage.setItem(THEME_KEY, theme);
      }

      // Events
      els.addBtn.addEventListener("click", addRecord);
      els.amountInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") addRecord();
      });

      els.monthSelect.addEventListener("change", () => {
        render();
      });

      els.clearBtn.addEventListener("click", clearMonth);
      els.exportBtn.addEventListener("click", exportCSV);

      els.tbody.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;

        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (action !== "del" || !id) return;

        const monthKey = els.monthSelect.value;
        const records = loadRecords(monthKey);
        const next = records.filter((r) => r.id !== id);
        saveRecords(monthKey, next);
        render();
      });

      // 套用上次主題（預設深色）
      applyTheme(localStorage.getItem(THEME_KEY) || "light");

      // 監聽切換
      els.themeToggle.addEventListener("change", () => {
        applyTheme(els.themeToggle.checked ? "light" : "dark");
      });

      // Init
      makeMonthOptions();
      // 預設日期為今天
      const yyyy = today.getFullYear();
      const mm = pad2(today.getMonth() + 1);
      const dd = pad2(today.getDate());
      els.dateInput.value = `${yyyy}-${mm}-${dd}`;
      render();
    </script>
  </body>
</html>
